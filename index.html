<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MKV/MP4 Player with Subtitles</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css"
    />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
      }
      html,
      body {
        width: 100%;
        height: 100%;
      }
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        z-index: 9999;
      }
      #loadingOverlay.hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="loadingOverlay">Loading...</div>
    <script>
      if (!sessionStorage.getItem("reloadedOnce")) {
        sessionStorage.setItem("reloadedOnce", "true");
      } else {
        sessionStorage.removeItem("reloadedOnce");
      }
    </script>
    <video id="videoPlayer" playsinline>
      <source src="/video" type="video/mp4" />
      <source src="/video" type="video/x-matroska" />
    </video>
    <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.min.js"></script>
    <script
      src="/libs/subtitles-octopus.js"
      onerror="console.error('Failed to load SubtitlesOctopus library')"
    ></script>
    <script>
      // Check if SubtitlesOctopus loaded
      setTimeout(() => {
        if (typeof window.SubtitlesOctopus === "undefined") {
          console.error(
            "SubtitlesOctopus library not available after 1 second"
          );
        } else {
          console.log("SubtitlesOctopus library loaded successfully");
        }
      }, 1000);
      const video = document.getElementById("videoPlayer");
      const loadingOverlay = document.getElementById("loadingOverlay");

      // Hide loading overlay when video is ready
      video.addEventListener("canplay", () => {
        loadingOverlay.classList.add("hidden");
      });

      const plyr = new Plyr(video, {
        controls: [
          "play-large",
          "play",
          "progress",
          "current-time",
          "duration",
          "mute",
          "volume",
          "settings",
          "fullscreen",
        ],
        settings: ["captions", "quality", "speed", "loop"],
        ratio: "16:9",
        keyboard: { focused: true, global: true },
      }); // SubtitlesOctopus integration with better error handling
      console.log("Starting subtitle loading...");

      // Wait for video to be ready before loading subtitles
      video.addEventListener("loadedmetadata", () => {
        console.log("Video metadata loaded, fetching subtitles...");

        fetch("/subtitles")
          .then((response) => {
            console.log("Subtitle response status:", response.status);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
          })
          .then((assText) => {
            console.log("Received subtitle text, length:", assText.length);
            console.log("First 200 chars:", assText.substring(0, 200));

            if (!assText || assText.length < 50) {
              console.warn("Subtitle text too short or empty");
              return;
            }

            // Check if SubtitlesOctopus is loaded
            if (typeof window.SubtitlesOctopus === "undefined") {
              console.error("SubtitlesOctopus not loaded!");
              return;
            }
            const options = {
              video: video,
              subContent: assText,
              workerUrl: "/libs/subtitles-octopus-worker.js",
              fonts: [],
              fallbackFont: "/libs/ARIALBD.TTF",
              // Canvas optimization options
              renderMode: "wasm-blend",
              targetFps: 24,
              // Additional rendering options
              prescaleFactor: 1.0,
              prescaleHeightLimit: 1080,
              maxRenderHeight: 1080,
              onReady: () => {
                console.log("SubtitlesOctopus ready and rendering!");
                // Try to optimize canvas after creation
                const canvases = document.querySelectorAll("canvas");
                canvases.forEach((canvas) => {
                  try {
                    const ctx = canvas.getContext("2d");
                    if (ctx && typeof ctx.getContextAttributes === "function") {
                      // Recreate context with willReadFrequently option
                      const newCtx = canvas.getContext("2d", {
                        willReadFrequently: true,
                      });
                    }
                  } catch (e) {
                    console.log("Could not optimize canvas context:", e);
                  }
                });
              },
              onError: (e) => {
                console.error("SubtitlesOctopus error:", e);
              },
            };
            console.log("Creating SubtitlesOctopus instance...");

            // Patch createElement to add willReadFrequently to canvas contexts
            const originalCreateElement = document.createElement;
            document.createElement = function (tagName) {
              const element = originalCreateElement.call(this, tagName);
              if (tagName.toLowerCase() === "canvas") {
                const originalGetContext = element.getContext;
                element.getContext = function (
                  contextType,
                  contextAttributes = {}
                ) {
                  if (contextType === "2d") {
                    contextAttributes.willReadFrequently = true;
                  }
                  return originalGetContext.call(
                    this,
                    contextType,
                    contextAttributes
                  );
                };
              }
              return element;
            };

            window.octopus = new window.SubtitlesOctopus(options);

            // Restore original createElement after initialization
            setTimeout(() => {
              document.createElement = originalCreateElement;
            }, 1000);
          })
          .catch((error) => {
            console.error("Error loading subtitles:", error);
          });
      });
    </script>
  </body>
</html>
